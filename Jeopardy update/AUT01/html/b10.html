<link href="https://fonts.cdnfonts.com/css/ds-digital" rel="stylesheet">
<link rel="stylesheet" href="AUT01/css/timer.css">

<div class="text-center pan1">
  <div class="mx-auto content-ncnt">
    <div class="mx-auto my-auto h-100">
      <div class="row mx-auto h-100">
        <div class="col-12 p-0 mx-auto my-auto h-100">
          <div id="pasos" class="h-100"></div>
          <div id="timerVisual">30</div>
        </div>
      </div>
    </div>
  </div>
</div>

<audio id="audios_DL"><source type="audio/mp3"></audio>
<a id="pdf" href="" download></a>

<script>
window.puntosAzules = 0;
window.puntosRojos = 0;
let preguntasUsadas = [];
let ultimoBotonUsado = '';
let puntosPreguntaActual = 0;

$(document).ready(function () {
  cargarSVG();

  function cargarSVG() {
    $.ajax({
      url: 'AUT01/images/svg/b10-01.svg',
      type: 'GET',
      complete: function (xhr) {
        $('#pasos').html(xhr.responseText);
        svg();
        activarBotonesDePregunta();
      }
    });
  }

  function activarBotonesDePregunta() {
    $('[id^=btn-]').off().on('click', function () {
      const id = $(this).attr('id');
      const partes = id.replace('btn-', '').split('-');
      const base = partes[0];
      const puntos = partes[1];

      ultimoBotonUsado = id;
      cargarPreguntaSVG(base, puntos);
    });
  }

  function cargarPreguntaSVG(nombreArchivo, puntos) {
    const file = `AUT01/images/svg/${nombreArchivo}_${puntos}.svg`;
    puntosPreguntaActual = parseInt(puntos);
    ultimoBotonUsado = `btn-${nombreArchivo}-${puntos}`;

    $.ajax({
      url: file,
      type: 'GET',
      dataType: 'text',
      success: function (data) {
        $('#pasos').html(data);

        let cronometro;
        let tiempoRestante = 30;

        function iniciarCronometro() {
          $('#timerVisual').text(tiempoRestante).css({
            'background-color': '#000',
            'color': '#fff'
          }).show();

          cronometro = setInterval(() => {
            tiempoRestante--;
            $('#timerVisual').text(tiempoRestante);

            if (tiempoRestante <= 0) {
              clearInterval(cronometro);
              $('#timerVisual').text('X').css('background-color', '#e74c3c');

              new Audio('AUT01/audio/incorrecto.mp3').play();
              $('#reveal-cover').fadeOut(300);

              setTimeout(() => {
                $('#timerVisual').fadeOut();
                volverAlTablero();
              }, 2500);
            }
          }, 1000);
        }

        setTimeout(() => {
          iniciarCronometro();

          $('[id^=btn-]').off().on('click', function () {
            const id = $(this).attr('id');

            // Descubrir => solo pausa el cronÃ³metro, no oculta el timer
            if (id.startsWith('btn-dsc')) {
              clearInterval(cronometro);
              $('#reveal-cover').fadeOut(300);
              return;
            }

            clearInterval(cronometro);

            // Azul
            if (id.includes('btn-azul')) {
              window.puntosAzules += puntosPreguntaActual;
              $('#marcadorAzul').html(window.puntosAzules);
              new Audio('AUT01/audio/correcto.mp3').play();
            }

            // Rojo
            if (id.includes('btn-rojo')) {
              window.puntosRojos += puntosPreguntaActual;
              $('#marcadorRojo').html(window.puntosRojos);
              new Audio('AUT01/audio/correcto.mp3').play();
            }

            // Incorrecto manual
            if (id.includes('btn-incorr')) {
              new Audio('AUT01/audio/incorrecto.mp3').play();
            }

            // Guardar pregunta usada
            if (!preguntasUsadas.includes(ultimoBotonUsado)) {
              preguntasUsadas.push(ultimoBotonUsado);

              if (preguntasUsadas.length === 1) {
                $.ajax({
                  url: 'AUT01/html/b11.html',
                  type: 'GET',
                  success: function (xhr) {
                    $('.wrapper').html(xhr);
                  },
                  error: function () {
                    alert('No se pudo cargar la siguiente slide');
                  }
                });
                return;
              }
            }

            $('#timerVisual').fadeOut();
            volverAlTablero();
          });
        }, 50);
      }
    });
  }

  function volverAlTablero() {
    $.ajax({
      url: 'AUT01/images/svg/b10-01.svg',
      type: 'GET',
      dataType: 'text',
      success: function (data) {
        $('#pasos').html(data);
        $('#timerVisual').hide().text('30');

        setTimeout(() => {
          activarBotonesDePregunta();
          if (typeof svg === 'function') svg();

          preguntasUsadas.forEach(id => {
            const svg = document.querySelector('#pasos svg');
            const btnGroup = svg.querySelector(`#${id}`);
            const rect = btnGroup?.querySelector('rect');
            if (!rect || !btnGroup) return;

            const overlayRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            overlayRect.setAttribute("x", rect.getAttribute('x'));
            overlayRect.setAttribute("y", rect.getAttribute('y'));
            overlayRect.setAttribute("width", rect.getAttribute('width'));
            overlayRect.setAttribute("height", rect.getAttribute('height'));
            overlayRect.setAttribute("fill", "#5f27cd");
            overlayRect.setAttribute("opacity", "1.0");

            btnGroup.parentNode.appendChild(overlayRect);
            btnGroup.style.pointerEvents = 'none';
            btnGroup.style.cursor = 'default';
          });
        }, 50);
      }
    });
  }

  function svg() {
    $('#marcadorAzul').html(window.puntosAzules);
    $('#marcadorRojo').html(window.puntosRojos);
  }
});
</script>
